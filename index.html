<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<title>Whisky Coloring — Amber Palette (CIEDE2000 + 21 Colors)</title>

<style>
:root { --btn-tap-scale: .96; }
html, body {
  height: 100%; margin: 0;
  font-family:'Noto Sans JP', sans-serif;
  color: #fff; text-align: center;
  overflow: hidden;
  background: radial-gradient(circle at center,#5a2b08 0%,#2b1a09 70%,#100502 100%);
  animation: glowShift 24s ease-in-out infinite;
  transition: background 3s ease;
}
@keyframes glowShift {
  0%{background-color:#1a0a04}
  25%{background-color:#8c4b08}
  50%{background-color:#e0a240}
  75%{background-color:#9c3c06}
  100%{background-color:#1a0a04}
}

/* 🎨 カラーバー */
#amberVerticalBar {
  position: fixed;
  top: 0; left: 0;
  width: 100vw;
  height: 100vh;
  display: flex;
  flex-direction: column;
  z-index: 99999 !important;
  box-shadow: 0 8px 28px rgba(255, 200, 130, 0.25);
  transition: transform 0.45s ease-in-out;
  overflow-y: auto;
  cursor: pointer;
  border-radius: 16px;
  transform: translateX(0);
  will-change: transform;
}
#amberVerticalBar.compact {
  transform: translateX(-105%);
  opacity: 0.95;
  pointer-events: none;
}

#amberVerticalBar .segment {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
}
#amberVerticalBar .segment span {
  font-size: .75rem;
  color: #fff;
  text-align: center;
  mix-blend-mode: difference;
}

/* ボタン */
button {
  font-size:clamp(1.1rem,4vw,1.4rem);
  padding:14px 28px;border:none;border-radius:40px;
  color:#fff;font-weight:700;cursor:pointer;
  z-index:5000;transition:transform .15s ease;
}
button:active{transform:scale(var(--btn-tap-scale));}

#cameraBtn {
  position:fixed;bottom:120px;left:50%;transform:translateX(-50%);
  background:linear-gradient(145deg,#d4a760,#b87900);
  box-shadow:0 0 14px rgba(255,204,102,.7);
}
#exitBtn {
  position:fixed;bottom:40px;left:50%;transform:translateX(-50%);
  background:linear-gradient(145deg,#b04,#600);
  box-shadow:0 0 14px rgba(255,100,100,.7);
}

/* 🎯 結果バー（最初は非表示） */
#resultBar {
  position: fixed;
  top: 32px;
  left: 50%;
  transform: translateX(-50%);
  min-width: 82%;
  padding: 16px 20px;
  background: rgba(0,0,0,0.70);
  color: #fff;
  font-weight: 900;
  font-size: clamp(1.35rem, 5vw, 1.7rem);
  line-height: 1.6;
  text-align: center;
  z-index: 9999;
  border-radius: 16px;
  border: 2px solid rgba(255,255,255,0.25);
  backdrop-filter: blur(8px);
  text-shadow: 0 0 10px rgba(0,0,0,0.9);

  opacity: 0;
  pointer-events: none;
  transition: opacity .4s ease;
}
#resultBar.show {
  opacity: 1;
  pointer-events: auto;
}

.hidden{display:none!important;}

#video{
  position:fixed;inset:0;width:100%;height:100%;
  object-fit:cover;z-index:0;background:#000;
  pointer-events:none;
}

#target{
  position:fixed;top:50%;left:50%;width:80px;height:80px;border-radius:50%;
  transform:translate(-50%,-50%);z-index:998;pointer-events:none;
  background:radial-gradient(circle at center,rgba(255,215,160,0.0)40%,rgba(255,195,120,0.35)70%,rgba(255,175,80,0.55)100%);
  box-shadow:0 0 14px rgba(255,190,120,0.3);opacity:0;transition:opacity 1.2s ease;
}
#target.active{opacity:1;}
#target.flash{animation:amberPulse .6s ease-out;}

@keyframes amberPulse{
  0%{box-shadow:0 0 20px rgba(255,220,150,0.9);transform:translate(-50%,-50%) scale(1.1);}
  50%{box-shadow:0 0 28px rgba(255,230,170,0.8);transform:translate(-50%,-50%) scale(1.2);}
  100%{box-shadow:0 0 14px rgba(255,190,120,0.3);transform:translate(-50%,-50%) scale(1);}
}

#glass {
  position: fixed; top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  width: clamp(100px, 25vw, 160px);
  opacity: 0.9; z-index: 500; pointer-events: none;
  filter: drop-shadow(0 0 12px rgba(255,255,255,0.45));
}
</style>
</head>
<body>
<video id="video" playsinline webkit-playsinline muted class="hidden"></video>
<canvas id="canvas" class="hidden"></canvas>
<div id="target"></div>

<div id="amberVerticalBar">
  <div class="segment" style="background:#fffef5;"><span>Gin Clear<br>ジン・クリア</span></div>
  <div class="segment" style="background:#faf5e0;"><span>White Wine<br>白ワイン</span></div>
  <div class="segment" style="background:#f9efb9;"><span>Pale Straw<br>淡い麦わら色</span></div>
  <div class="segment" style="background:#f6e086;"><span>Pale Gold<br>淡い金色</span></div>
  <div class="segment" style="background:#f1c94e;"><span>Corn<br>トウモロコシ色</span></div>
  <div class="segment" style="background:#e4b22f;"><span>Yellow Gold<br>黄金色</span></div>
  <div class="segment" style="background:#c79425;"><span>Old Gold<br>オールドゴールド</span></div>
  <div class="segment" style="background:#a86b17;"><span>Amber<br>琥珀色</span></div>
  <div class="segment" style="background:#94640f;"><span>Deep Gold<br>深い金色</span></div>
  <div class="segment" style="background:#864b0a;"><span>Sherry<br>シェリー</span></div>
  <div class="segment" style="background:#733b05;"><span>Deep Copper<br>深い銅色</span></div>
  <div class="segment" style="background:#633306;"><span>Burnished<br>磨かれた色</span></div>
  <div class="segment" style="background:#532907;"><span>Oloroso Sherry<br>オロロソシェリー</span></div>
  <div class="segment" style="background:#452106;"><span>Chestnut Muscat<br>マスカット栗色</span></div>
  <div class="segment" style="background:#391b05;"><span>Gold Brown<br>金茶色</span></div>
  <div class="segment" style="background:#301505;"><span>Polished Mahogany<br>磨かれたマホガニー</span></div>
  <div class="segment" style="background:#271104;"><span>Mahogany<br>マホガニー</span></div>
  <div class="segment" style="background:#1f0d03;"><span>Brown Chocolate<br>茶色のチョコレート</span></div>
  <div class="segment" style="background:#170903;"><span>Old Cask<br>古樽色</span></div>
  <div class="segment" style="background:#0f0502;"><span>Brown Sherry<br>茶色のシェリー</span></div>
  <div class="segment" style="background:#070200;"><span>Black<br>黒</span></div>
</div>

<div id="resultBar">—</div>

<button id="cameraBtn">📷 カメラ起動／判定</button>
<button id="exitBtn">🛑 終了</button>
<img id="glass" src="glass.png" alt="Whisky Glass">
	<script>
const video=document.getElementById('video');
const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d');
const cameraBtn=document.getElementById('cameraBtn');
const exitBtn=document.getElementById('exitBtn');
const result=document.getElementById('resultBar');
const target=document.getElementById('target');
const bar=document.getElementById('amberVerticalBar');
let stream=null;

/* カメラ起動 */
async function startCamera(){
  try{
    stream=await navigator.mediaDevices.getUserMedia({
      video:{facingMode:"environment"},
      audio:false
    });
    video.srcObject=stream;
    video.classList.remove('hidden');
    await video.play();
    target.classList.add('active');
    bar.classList.add('compact');
  }catch(e){
    alert('カメラにアクセスできません。ブラウザで許可してください。');
  }
}

/* カメラ停止 */
function stopCamera(){
  if(stream){ stream.getTracks().forEach(t=>t.stop()); }
  stream=null;
  video.classList.add('hidden');
  target.classList.remove('active');
  result.classList.remove('show'); // 結果バーを隠す
}

/* 判定処理 */
function detectColor(){
  if(!stream){
    alert('カメラを起動してください。');
    return;
  }
  if(!video.videoWidth) return;

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video,0,0);

  const x = Math.floor(canvas.width/2);
  const y = Math.floor(canvas.height/2);
  const d = ctx.getImageData(x,y,1,1).data;

  const hex = rgbToHex(d[0],d[1],d[2]);
  const nearest = getNearestAmberCIEDE2000(hex);

  result.innerHTML = `
    <div style="font-size:1.1rem;opacity:.85;">Detected Color</div>
    <div style="margin-top:4px;font-size:1.5rem;font-weight:900;">
      <span style="
        background:rgba(255,255,255,0.15);
        padding:4px 12px;
        border-radius:999px;
        border:1px solid rgba(255,255,255,0.35);
        display:inline-block;
      ">${nearest.name}</span>
    </div>
    <div style="margin-top:6px;font-size:1.05rem;opacity:.95;">
      判定結果：${nearest.jp}
    </div>
  `;

  result.classList.add('show');

  document.body.style.animation='none';
  document.body.style.background=
    `radial-gradient(circle at center, ${nearest.hex} 0%, #120802 75%, #0a0402 100%)`;

  target.classList.add('flash');
  setTimeout(()=>target.classList.remove('flash'),600);
}

/* ボタン */
cameraBtn.addEventListener('click',()=>{
  if(!stream) startCamera();
  else detectColor();
});
exitBtn.addEventListener('click',stopCamera);
bar.addEventListener('click',()=>bar.classList.toggle('compact'));

/* 色変換 */
function rgbToHex(r,g,b){
  return '#'+[r,g,b].map(x=>x.toString(16).padStart(2,'0')).join('');
}
function hexToRgb(hex){
  const v=hex.match(/\w\w/g).map(x=>parseInt(x,16));
  return {r:v[0],g:v[1],b:v[2]};
}
function rgbToLab(r,g,b){
  r/=255;g/=255;b/=255;
  r=(r>0.04045)?Math.pow((r+0.055)/1.055,2.4):r/12.92;
  g=(g>0.04045)?Math.pow((g+0.055)/1.055,2.4):g/12.92;
  b=(b>0.04045)?Math.pow((b+0.055)/1.055,2.4):b/12.92;

  const X=(r*0.4124+g*0.3576+b*0.1805)/0.95047;
  const Y=(r*0.2126+g*0.7152+b*0.0722)/1.0;
  const Z=(r*0.0193+g*0.1192+b*0.9505)/1.08883;

  const f=t=>(t>0.008856)?Math.cbrt(t):(7.787*t)+(16/116);
  return {
    L:(116*f(Y))-16,
    a:500*(f(X)-f(Y)),
    b:200*(f(Y)-f(Z))
  };
}

/* ΔE 2000 */
function deltaE00(l1,l2){
  const avgL=(l1.L+l2.L)/2;
  const C1=Math.hypot(l1.a,l1.b);
  const C2=Math.hypot(l2.a,l2.b);
  const avgC=(C1+C2)/2;
  const G=0.5*(1-Math.sqrt(Math.pow(avgC,7)/(Math.pow(avgC,7)+Math.pow(25,7))));
  const a1p=l1.a*(1+G);
  const a2p=l2.a*(1+G);
  const C1p=Math.hypot(a1p,l1.b);
  const C2p=Math.hypot(a2p,l2.b);
  const avgCp=(C1p+C2p)/2;

  const h1p=(Math.atan2(l1.b,a1p)*180/Math.PI+360)%360;
  const h2p=(Math.atan2(l2.b,a2p)*180/Math.PI+360)%360;

  let dhp=h2p-h1p;
  if(Math.abs(dhp)>180) dhp+=(dhp>0?-360:360);

  const dLp=l2.L-l1.L;
  const dCp=C2p-C1p;
  const dHp=2*Math.sqrt(C1p*C2p)*Math.sin((dhp/2)*Math.PI/180);

  const avgHp=(Math.abs(h1p-h2p)>180)?(h1p+h2p+360)/2:(h1p+h2p)/2;

  const T=
    1-0.17*Math.cos((avgHp-30)*Math.PI/180)+
    0.24*Math.cos(2*avgHp*Math.PI/180)+
    0.32*Math.cos((3*avgHp+6)*Math.PI/180)-
    0.20*Math.cos((4*avgHp-63)*Math.PI/180);

  const SL=1+((0.015*Math.pow((avgL-50),2))/Math.sqrt(20+Math.pow((avgL-50),2)));
  const SC=1+0.045*avgCp;
  const SH=1+0.015*avgCp*T;

  const deltaTheta=30*Math.exp(-Math.pow(((avgHp-275)/25),2));
  const RC=2*Math.sqrt(Math.pow(avgCp,7)/(Math.pow(avgCp,7)+Math.pow(25,7)));
  const RT=-RC*Math.sin(2*deltaTheta*Math.PI/180);

  return Math.sqrt(
    Math.pow((dLp/SL),2)+
    Math.pow((dCp/SC),2)+
    Math.pow((dHp/SH),2)+
    RT*(dCp/SC)*(dHp/SH)
  );
}

/* Amber 21 */
const AMBER_21=[
  {name:'Gin Clear',jp:'ジン・クリア',hex:'#fffef5'},
  {name:'White Wine',jp:'白ワイン',hex:'#faf5e0'},
  {name:'Pale Straw',jp:'淡い麦わら色',hex:'#f9efb9'},
  {name:'Pale Gold',jp:'淡い金色',hex:'#f6e086'},
  {name:'Corn',jp:'トウモロコシ色',hex:'#f1c94e'},
  {name:'Yellow Gold',jp:'黄金色',hex:'#e4b22f'},
  {name:'Old Gold',jp:'オールドゴールド',hex:'#c79425'},
  {name:'Amber',jp:'琥珀色',hex:'#a86b17'},
  {name:'Deep Gold',jp:'深い金色',hex:'#94640f'},
  {name:'Sherry',jp:'シェリー',hex:'#864b0a'},
  {name:'Deep Copper',jp:'深い銅色',hex:'#733b05'},
  {name:'Burnished',jp:'磨かれた色',hex:'#633306'},
  {name:'Oloroso Sherry',jp:'オロロソシェリー',hex:'#532907'},
  {name:'Chestnut Muscat',jp:'マスカット栗色',hex:'#452106'},
  {name:'Gold Brown',jp:'金茶色',hex:'#391b05'},
  {name:'Polished Mahogany',jp:'磨かれたマホガニー',hex:'#301505'},
  {name:'Mahogany',jp:'マホガニー',hex:'#271104'},
  {name:'Brown Chocolate',jp:'茶色のチョコレート',hex:'#1f0d03'},
  {name:'Old Cask',jp:'古樽色',hex:'#170903'},
  {name:'Brown Sherry',jp:'茶色のシェリー',hex:'#0f0502'},
  {name:'Black',jp:'黒',hex:'#070200'}
];

function getNearestAmberCIEDE2000(hex){
  const s=hexToRgb(hex);
  const sLab=rgbToLab(s.r,s.g,s.b);
  let best=AMBER_21[0],bestDist=Infinity;
  for(const c of AMBER_21){
    const t=hexToRgb(c.hex);
    const tLab=rgbToLab(t.r,t.g,t.b);
    const d=deltaE00(sLab,tLab);
    if(d<bestDist){bestDist=d;best=c;}
  }
  return best;
}
</script>
</body>
</html>
